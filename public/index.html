<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>x402 Community Agent</title>
  <style>
    :root {
      --bg: #0a0e17;
      --card: #111827;
      --border: #1f2937;
      --text: #e5e7eb;
      --muted: #6b7280;
      --accent: #FF9900;
      --accent2: #FEBD69;
      --green: #34D399;
      --red: #F87171;
      --blue: #60A5FA;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { background: var(--bg); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; min-height: 100vh; }

    /* Header */
    .header { background: linear-gradient(135deg, #111827, #1a1f2e); border-bottom: 1px solid var(--border); padding: 20px 24px; display: flex; align-items: center; justify-content: space-between; gap: 16px; flex-wrap: wrap; }
    .header h1 { font-size: 20px; font-weight: 700; }
    .header h1 span { color: var(--accent); }
    .header-stats { display: flex; gap: 16px; flex-wrap: wrap; }
    .header-stat { text-align: center; }
    .header-stat .value { font-size: 18px; font-weight: 700; }
    .header-stat .label { font-size: 11px; color: var(--muted); text-transform: uppercase; }

    /* Layout */
    .main { max-width: 1200px; margin: 0 auto; padding: 24px; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px; }
    @media (max-width: 768px) { .grid { grid-template-columns: 1fr; } }

    /* Cards */
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 20px; }
    .card h2 { font-size: 14px; font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 16px; }
    .card.full { grid-column: 1 / -1; }

    /* Platforms */
    .platforms { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 10px; }
    .platform { display: flex; align-items: center; gap: 8px; padding: 10px 12px; border-radius: 8px; background: rgba(255,255,255,0.03); border: 1px solid var(--border); }
    .platform .dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
    .platform .dot.on { background: var(--green); box-shadow: 0 0 6px var(--green); }
    .platform .dot.off { background: var(--red); opacity: 0.5; }
    .platform .name { font-size: 13px; font-weight: 500; }

    /* Buttons */
    .btn { padding: 10px 20px; border-radius: 8px; border: none; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
    .btn-primary { background: linear-gradient(135deg, var(--accent), #e08800); color: #000; }
    .btn-primary:hover { opacity: 0.9; transform: translateY(-1px); }
    .btn-secondary { background: rgba(255,255,255,0.05); color: var(--text); border: 1px solid var(--border); }
    .btn-secondary:hover { background: rgba(255,255,255,0.1); }
    .btn-green { background: var(--green); color: #000; }
    .btn-green:hover { opacity: 0.9; }
    .btn:disabled { opacity: 0.4; cursor: not-allowed; }
    .btn-row { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 16px; }

    /* Strategy selector */
    .strategy-select { display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; }
    .strategy-btn { padding: 8px 16px; border-radius: 20px; border: 1px solid var(--border); background: transparent; color: var(--text); font-size: 13px; cursor: pointer; transition: all 0.2s; }
    .strategy-btn.active { background: var(--accent); color: #000; border-color: var(--accent); font-weight: 600; }
    .strategy-btn:hover:not(.active) { border-color: var(--accent); color: var(--accent); }

    /* Preview */
    .preview-tabs { display: flex; gap: 4px; margin-bottom: 12px; overflow-x: auto; }
    .preview-tab { padding: 6px 14px; border-radius: 6px 6px 0 0; background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-bottom: none; font-size: 12px; color: var(--muted); cursor: pointer; white-space: nowrap; }
    .preview-tab.active { background: var(--card); color: var(--accent); border-color: var(--accent); }
    .preview-content { background: rgba(0,0,0,0.3); border: 1px solid var(--border); border-radius: 0 8px 8px 8px; padding: 16px; min-height: 120px; max-height: 400px; overflow-y: auto; font-size: 13px; line-height: 1.6; white-space: pre-wrap; word-break: break-word; }

    /* Platform checkboxes */
    .platform-checks { display: flex; flex-wrap: wrap; gap: 10px; margin: 16px 0; }
    .platform-check { display: flex; align-items: center; gap: 6px; font-size: 13px; }
    .platform-check input { accent-color: var(--accent); width: 16px; height: 16px; }

    /* Logs */
    .logs { background: rgba(0,0,0,0.3); border: 1px solid var(--border); border-radius: 8px; padding: 12px; max-height: 250px; overflow-y: auto; font-family: 'Consolas', 'Monaco', monospace; font-size: 12px; line-height: 1.8; }
    .log-entry { display: flex; gap: 8px; }
    .log-time { color: var(--muted); white-space: nowrap; }
    .log-info { color: var(--blue); }
    .log-error { color: var(--red); }

    /* Stats bar */
    .stats-row { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 12px; }
    .stat-item { text-align: center; padding: 12px 8px; background: rgba(255,255,255,0.03); border-radius: 8px; }
    .stat-item .val { font-size: 22px; font-weight: 700; color: var(--accent); }
    .stat-item .lbl { font-size: 11px; color: var(--muted); margin-top: 4px; }

    /* Image preview */
    .image-preview { margin-top: 12px; text-align: center; }
    .image-preview img { max-width: 300px; border-radius: 8px; border: 1px solid var(--border); }

    /* Spinner */
    .spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* History */
    .history-item { padding: 10px; border-bottom: 1px solid var(--border); font-size: 13px; }
    .history-item:last-child { border-bottom: none; }
    .history-time { color: var(--muted); font-size: 11px; }
    .history-platforms { display: flex; gap: 6px; margin-top: 4px; }
    .history-badge { font-size: 11px; padding: 2px 8px; border-radius: 4px; }
    .history-badge.ok { background: rgba(52,211,153,0.15); color: var(--green); }
    .history-badge.fail { background: rgba(248,113,113,0.15); color: var(--red); }
    .history-badge.manual { background: rgba(96,165,250,0.15); color: var(--blue); }
  </style>
</head>
<body>

<div class="header">
  <h1><span>x402</span> Community Agent</h1>
  <div class="header-stats">
    <div class="header-stat">
      <div class="value" id="h-apis">--</div>
      <div class="label">APIs</div>
    </div>
    <div class="header-stat">
      <div class="value" id="h-uptime">--</div>
      <div class="label">Uptime</div>
    </div>
    <div class="header-stat">
      <div class="value" style="color:var(--green)" id="h-budget">--</div>
      <div class="label">Budget</div>
    </div>
  </div>
</div>

<div class="main">
  <!-- Platforms + Stats -->
  <div class="grid">
    <div class="card">
      <h2>Platforms</h2>
      <div class="platforms" id="platforms"></div>
    </div>
    <div class="card">
      <h2>Live Stats (x402 Bazaar)</h2>
      <div class="stats-row" id="stats-row">
        <div class="stat-item"><div class="val">--</div><div class="lbl">Loading...</div></div>
      </div>
    </div>
  </div>

  <!-- Content Generation -->
  <div class="card full" style="margin-bottom:20px">
    <h2>Generate Content</h2>

    <div class="strategy-select" id="strategy-select">
      <button class="strategy-btn active" data-strategy="daily-stats">Daily Stats</button>
      <button class="strategy-btn" data-strategy="weekly-recap">Weekly Recap</button>
      <button class="strategy-btn" data-strategy="new-api">New API Announce</button>
    </div>

    <div class="btn-row">
      <button class="btn btn-primary" id="btn-preview" onclick="generatePreview()">Generate Preview</button>
      <button class="btn btn-secondary" id="btn-telegram" onclick="sendToTelegram()" disabled>Send to Telegram</button>
      <button class="btn btn-green" id="btn-publish" onclick="publishAll()" disabled>Publish Selected</button>
    </div>

    <!-- Platform selection for publishing -->
    <div class="platform-checks" id="platform-checks"></div>

    <!-- Preview tabs -->
    <div id="preview-area" style="display:none">
      <div class="preview-tabs" id="preview-tabs"></div>
      <div class="preview-content" id="preview-content">Select a platform tab to see content...</div>
      <div class="image-preview" id="image-preview"></div>
    </div>
  </div>

  <!-- Logs + History -->
  <div class="grid">
    <div class="card">
      <h2>Activity Log</h2>
      <div class="logs" id="logs">
        <div class="log-entry"><span class="log-time">--</span> <span class="log-info">Dashboard loaded</span></div>
      </div>
    </div>
    <div class="card">
      <h2>Post History</h2>
      <div id="history">
        <div style="color:var(--muted);font-size:13px">No posts yet</div>
      </div>
    </div>
  </div>
</div>

<script>
  const API = '';
  let currentStrategy = 'daily-stats';
  let previewData = null;
  let activeTab = null;

  // ─── Init ──────────────────────────────────────────────────────
  async function init() {
    await Promise.all([loadStatus(), loadStats(), loadLogs(), loadHistory()]);
    // Refresh every 30s
    setInterval(loadStats, 30000);
    setInterval(loadLogs, 10000);
  }

  // ─── Load platform status ─────────────────────────────────────
  async function loadStatus() {
    try {
      const data = await fetchJson('/api/status');
      const el = document.getElementById('platforms');
      const checksEl = document.getElementById('platform-checks');
      el.innerHTML = '';
      checksEl.innerHTML = '';

      const names = { telegram: 'Telegram', discord: 'Discord', twitter: 'Twitter/X', reddit: 'Reddit', linkedin: 'LinkedIn', devto: 'Dev.to', farcaster: 'Farcaster', hn: 'HN' };

      for (const [name, status] of Object.entries(data.platforms)) {
        el.innerHTML += `<div class="platform"><div class="dot ${status.enabled ? 'on' : 'off'}"></div><div class="name">${names[name] || name}</div></div>`;
        checksEl.innerHTML += `<label class="platform-check"><input type="checkbox" value="${name}" ${status.enabled ? 'checked' : ''} />${names[name] || name}</label>`;
      }

      document.getElementById('h-budget').textContent = `${data.budget.remaining.toFixed(2)} USDC`;
    } catch (e) { console.error('Status load error:', e); }
  }

  // ─── Load live stats ──────────────────────────────────────────
  async function loadStats() {
    try {
      const s = await fetchJson('/api/stats');
      document.getElementById('h-apis').textContent = s.totalServices || 0;
      document.getElementById('h-uptime').textContent = `${s.uptimePercent || 0}%`;
      document.getElementById('stats-row').innerHTML = `
        <div class="stat-item"><div class="val">${s.totalServices || 0}</div><div class="lbl">APIs</div></div>
        <div class="stat-item"><div class="val">${s.uptimePercent || 0}%</div><div class="lbl">Uptime</div></div>
        <div class="stat-item"><div class="val">${s.recentCalls24h || 0}</div><div class="lbl">Calls 24h</div></div>
        <div class="stat-item"><div class="val">${s.totalPayments || 0}</div><div class="lbl">Payments</div></div>
        <div class="stat-item"><div class="val">${s.integrations || 0}</div><div class="lbl">Integrations</div></div>
        <div class="stat-item"><div class="val">${s.tests || 0}</div><div class="lbl">Tests</div></div>
      `;
    } catch (e) { console.error('Stats load error:', e); }
  }

  // ─── Strategy selection ───────────────────────────────────────
  document.getElementById('strategy-select').addEventListener('click', (e) => {
    if (!e.target.dataset.strategy) return;
    document.querySelectorAll('.strategy-btn').forEach(b => b.classList.remove('active'));
    e.target.classList.add('active');
    currentStrategy = e.target.dataset.strategy;
  });

  // ─── Generate preview ─────────────────────────────────────────
  async function generatePreview() {
    const btn = document.getElementById('btn-preview');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span> Generating...';

    try {
      previewData = await fetchJson('/api/preview', { method: 'POST', body: JSON.stringify({ strategy: currentStrategy }) });

      // Build tabs
      const tabsEl = document.getElementById('preview-tabs');
      tabsEl.innerHTML = '';
      const platforms = Object.keys(previewData.contents);
      platforms.forEach((p, i) => {
        const tab = document.createElement('div');
        tab.className = `preview-tab ${i === 0 ? 'active' : ''}`;
        tab.textContent = p.charAt(0).toUpperCase() + p.slice(1);
        tab.onclick = () => selectTab(p);
        tabsEl.appendChild(tab);
      });

      // Show first tab
      if (platforms.length > 0) selectTab(platforms[0]);

      // Show image
      const imgEl = document.getElementById('image-preview');
      imgEl.innerHTML = previewData.imageUrl ? `<img src="${previewData.imageUrl}" alt="Generated visual" />` : '';

      document.getElementById('preview-area').style.display = 'block';
      document.getElementById('btn-telegram').disabled = false;
      document.getElementById('btn-publish').disabled = false;
    } catch (e) {
      alert('Generation failed: ' + e.message);
    }

    btn.disabled = false;
    btn.textContent = 'Generate Preview';
  }

  function selectTab(platform) {
    activeTab = platform;
    document.querySelectorAll('.preview-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.preview-tab').forEach(t => {
      if (t.textContent.toLowerCase() === platform) t.classList.add('active');
    });

    const content = previewData.contents[platform];
    const el = document.getElementById('preview-content');
    el.textContent = typeof content === 'string' ? content : JSON.stringify(content, null, 2);
  }

  // ─── Send to Telegram for review ─────────────────────────────
  async function sendToTelegram() {
    if (!previewData) return;
    const btn = document.getElementById('btn-telegram');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span> Sending...';
    try {
      await fetchJson('/api/telegram-preview', { method: 'POST', body: JSON.stringify({ contents: previewData.contents, imageUrl: previewData.imageUrl }) });
      btn.textContent = 'Sent!';
      setTimeout(() => { btn.textContent = 'Send to Telegram'; btn.disabled = false; }, 2000);
    } catch (e) {
      alert('Send failed: ' + e.message);
      btn.textContent = 'Send to Telegram';
      btn.disabled = false;
    }
  }

  // ─── Publish to selected platforms ────────────────────────────
  async function publishAll() {
    if (!previewData) return;
    const checked = [...document.querySelectorAll('.platform-check input:checked')].map(c => c.value);
    if (checked.length === 0) { alert('Select at least one platform'); return; }

    if (!confirm(`Publish to ${checked.join(', ')}?`)) return;

    const btn = document.getElementById('btn-publish');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span> Publishing...';

    try {
      const result = await fetchJson('/api/publish', {
        method: 'POST',
        body: JSON.stringify({ contents: previewData.contents, imageUrl: previewData.imageUrl, platforms: checked, strategy: currentStrategy }),
      });

      let msg = 'Results:\n';
      for (const [p, r] of Object.entries(result.results)) {
        msg += `${r.success ? 'OK' : (r.manualPost ? 'MANUAL' : 'FAIL')} ${p}: ${r.message || ''}\n`;
      }
      alert(msg);
      loadHistory();
      loadLogs();
    } catch (e) { alert('Publish failed: ' + e.message); }

    btn.disabled = false;
    btn.textContent = 'Publish Selected';
  }

  // ─── Logs ─────────────────────────────────────────────────────
  async function loadLogs() {
    try {
      const logs = await fetchJson('/api/logs');
      const el = document.getElementById('logs');
      el.innerHTML = logs.map(l =>
        `<div class="log-entry"><span class="log-time">${l.time.slice(11, 19)}</span> <span class="log-${l.level}">${l.msg}</span></div>`
      ).join('') || '<div style="color:var(--muted)">No logs yet</div>';
      el.scrollTop = el.scrollHeight;
    } catch {}
  }

  // ─── History ──────────────────────────────────────────────────
  async function loadHistory() {
    try {
      const items = await fetchJson('/api/history');
      const el = document.getElementById('history');
      if (items.length === 0) { el.innerHTML = '<div style="color:var(--muted);font-size:13px">No posts yet</div>'; return; }
      el.innerHTML = items.reverse().map(h => {
        const badges = Object.entries(h.results).map(([p, r]) =>
          `<span class="history-badge ${r.success ? 'ok' : (r.manualPost ? 'manual' : 'fail')}">${p}</span>`
        ).join('');
        return `<div class="history-item"><div class="history-time">${new Date(h.time).toLocaleString()} — ${h.strategy || 'unknown'}</div><div class="history-platforms">${badges}</div></div>`;
      }).join('');
    } catch {}
  }

  // ─── Fetch helper ─────────────────────────────────────────────
  async function fetchJson(url, opts = {}) {
    const res = await fetch(API + url, { headers: { 'Content-Type': 'application/json' }, ...opts });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    return res.json();
  }

  init();
</script>
</body>
</html>
