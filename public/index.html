<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>x402 Community Agent</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
    :root {
      --bg: #06080f; --bg2: #0c1018; --card: #111827; --card2: #161f30;
      --border: #1e293b; --border2: #2d3a50;
      --text: #f1f5f9; --text2: #94a3b8; --text3: #64748b;
      --accent: #FF9900; --accent2: #FEBD69; --accent-dim: rgba(255,153,0,0.12);
      --green: #22c55e; --green-dim: rgba(34,197,94,0.12);
      --red: #ef4444; --red-dim: rgba(239,68,68,0.12);
      --blue: #3b82f6; --blue-dim: rgba(59,130,246,0.12);
      --purple: #a855f7; --purple-dim: rgba(168,85,247,0.12);
      --yellow: #eab308; --yellow-dim: rgba(234,179,8,0.12);
      --radius: 12px; --radius-sm: 8px;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { background: var(--bg); color: var(--text); font-family: 'Inter', -apple-system, sans-serif; min-height: 100vh; display: flex; }
    ::selection { background: var(--accent); color: #000; }
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

    /* ─── Sidebar ─── */
    .sidebar { width: 240px; background: var(--bg2); border-right: 1px solid var(--border); display: flex; flex-direction: column; position: fixed; top: 0; left: 0; bottom: 0; z-index: 100; transition: transform 0.3s; }
    .sidebar-brand { padding: 24px 20px; border-bottom: 1px solid var(--border); }
    .sidebar-brand h1 { font-size: 18px; font-weight: 800; display: flex; align-items: center; gap: 10px; }
    .sidebar-brand h1 .dot { width: 10px; height: 10px; border-radius: 50%; background: var(--accent); box-shadow: 0 0 12px var(--accent); }
    .sidebar-brand p { font-size: 11px; color: var(--text3); margin-top: 4px; }
    .sidebar-nav { flex: 1; padding: 12px 10px; }
    .nav-item { display: flex; align-items: center; gap: 12px; padding: 11px 14px; border-radius: var(--radius-sm); font-size: 13px; font-weight: 500; color: var(--text2); cursor: pointer; transition: all 0.2s; margin-bottom: 2px; border: 1px solid transparent; }
    .nav-item:hover { background: rgba(255,255,255,0.04); color: var(--text); }
    .nav-item.active { background: var(--accent-dim); color: var(--accent); border-color: rgba(255,153,0,0.2); }
    .nav-item svg { width: 18px; height: 18px; flex-shrink: 0; }
    .nav-badge { background: var(--accent); color: #000; font-size: 10px; font-weight: 700; padding: 1px 6px; border-radius: 8px; margin-left: auto; }
    .sidebar-footer { padding: 16px 20px; border-top: 1px solid var(--border); }
    .sidebar-footer .budget { font-size: 12px; color: var(--text3); }
    .sidebar-footer .budget-val { font-size: 18px; font-weight: 700; color: var(--green); margin-top: 2px; }

    /* ─── Main ─── */
    .main { flex: 1; margin-left: 240px; min-height: 100vh; }
    .topbar { padding: 16px 32px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; background: var(--bg); position: sticky; top: 0; z-index: 50; backdrop-filter: blur(12px); }
    .topbar h2 { font-size: 16px; font-weight: 600; }
    .topbar-stats { display: flex; gap: 20px; }
    .topbar-stat { text-align: center; }
    .topbar-stat .v { font-size: 16px; font-weight: 700; color: var(--accent); }
    .topbar-stat .l { font-size: 10px; color: var(--text3); text-transform: uppercase; letter-spacing: 0.5px; }
    .page { padding: 28px 32px; display: none; animation: fadeIn 0.3s; }
    .page.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

    /* ─── Cards ─── */
    .card { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 22px; margin-bottom: 20px; }
    .card-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 18px; }
    .card-title { font-size: 13px; font-weight: 600; color: var(--text2); text-transform: uppercase; letter-spacing: 0.6px; }
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; }
    .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 14px; }
    @media (max-width: 900px) { .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; } }

    /* ─── Stat Cards ─── */
    .stat-card { background: var(--card2); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 18px; text-align: center; transition: all 0.3s; }
    .stat-card:hover { border-color: var(--accent); transform: translateY(-2px); }
    .stat-card .val { font-size: 28px; font-weight: 800; background: linear-gradient(135deg, var(--accent), var(--accent2)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .stat-card .lbl { font-size: 11px; color: var(--text3); margin-top: 4px; text-transform: uppercase; letter-spacing: 0.4px; }

    /* ─── Platforms Grid ─── */
    .platform-card { background: var(--card2); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 16px; display: flex; align-items: center; gap: 14px; transition: all 0.2s; }
    .platform-card:hover { border-color: var(--border2); }
    .platform-icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0; }
    .platform-info { flex: 1; min-width: 0; }
    .platform-name { font-size: 13px; font-weight: 600; }
    .platform-status { font-size: 11px; margin-top: 2px; }
    .platform-status.on { color: var(--green); }
    .platform-status.off { color: var(--text3); }
    .status-dot { display: inline-block; width: 7px; height: 7px; border-radius: 50%; margin-right: 5px; }
    .status-dot.on { background: var(--green); box-shadow: 0 0 8px var(--green); }
    .status-dot.off { background: var(--text3); }

    /* ─── Buttons ─── */
    .btn { padding: 10px 20px; border-radius: var(--radius-sm); border: none; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px; font-family: inherit; }
    .btn:disabled { opacity: 0.35; cursor: not-allowed; }
    .btn-accent { background: linear-gradient(135deg, var(--accent), #e08800); color: #000; }
    .btn-accent:hover:not(:disabled) { box-shadow: 0 4px 16px rgba(255,153,0,0.3); transform: translateY(-1px); }
    .btn-ghost { background: transparent; color: var(--text2); border: 1px solid var(--border); }
    .btn-ghost:hover:not(:disabled) { background: rgba(255,255,255,0.04); color: var(--text); }
    .btn-green { background: var(--green); color: #000; }
    .btn-green:hover:not(:disabled) { box-shadow: 0 4px 16px rgba(34,197,94,0.3); }
    .btn-red { background: var(--red-dim); color: var(--red); border: 1px solid rgba(239,68,68,0.2); }
    .btn-blue { background: var(--blue-dim); color: var(--blue); border: 1px solid rgba(59,130,246,0.2); }
    .btn-sm { padding: 6px 14px; font-size: 12px; }
    .btn-xs { padding: 4px 10px; font-size: 11px; }
    .btn-row { display: flex; gap: 10px; flex-wrap: wrap; }

    /* ─── Strategy Pills ─── */
    .pills { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 20px; }
    .pill { padding: 8px 18px; border-radius: 20px; border: 1px solid var(--border); background: transparent; color: var(--text2); font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.2s; font-family: inherit; }
    .pill:hover { border-color: var(--accent); color: var(--accent); }
    .pill.active { background: var(--accent); color: #000; border-color: var(--accent); font-weight: 600; }

    /* ─── Tabs Preview ─── */
    .tabs { display: flex; gap: 2px; border-bottom: 1px solid var(--border); margin-bottom: 16px; overflow-x: auto; }
    .tab { padding: 10px 18px; font-size: 12px; font-weight: 500; color: var(--text3); cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.2s; white-space: nowrap; font-family: inherit; background: none; border-top: none; border-left: none; border-right: none; }
    .tab:hover { color: var(--text2); }
    .tab.active { color: var(--accent); border-bottom-color: var(--accent); }
    .tab-content { background: rgba(0,0,0,0.25); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 18px; min-height: 140px; max-height: 400px; overflow-y: auto; font-size: 13px; line-height: 1.7; white-space: pre-wrap; word-break: break-word; font-family: 'Consolas', monospace; }

    /* ─── Checkboxes ─── */
    .checks { display: flex; flex-wrap: wrap; gap: 12px; margin: 18px 0; }
    .check-item { display: flex; align-items: center; gap: 8px; padding: 8px 14px; border-radius: var(--radius-sm); background: var(--card2); border: 1px solid var(--border); cursor: pointer; transition: all 0.2s; font-size: 13px; }
    .check-item:hover { border-color: var(--border2); }
    .check-item.checked { border-color: var(--accent); background: var(--accent-dim); }
    .check-item input { display: none; }

    /* ─── Forms (Settings) ─── */
    .form-group { margin-bottom: 20px; }
    .form-label { display: block; font-size: 12px; font-weight: 600; color: var(--text2); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.4px; }
    .form-input { width: 100%; padding: 10px 14px; border-radius: var(--radius-sm); border: 1px solid var(--border); background: var(--bg); color: var(--text); font-size: 13px; font-family: inherit; outline: none; transition: border-color 0.2s; }
    .form-input:focus { border-color: var(--accent); }
    .form-input::placeholder { color: var(--text3); }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .form-hint { font-size: 11px; color: var(--text3); margin-top: 4px; }
    .form-section { background: var(--card2); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; margin-bottom: 16px; }
    .form-section-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; }
    .form-section-title { font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 10px; }
    .toggle { position: relative; width: 40px; height: 22px; background: var(--border); border-radius: 11px; cursor: pointer; transition: background 0.3s; flex-shrink: 0; }
    .toggle.on { background: var(--green); }
    .toggle::after { content: ''; position: absolute; top: 3px; left: 3px; width: 16px; height: 16px; border-radius: 50%; background: #fff; transition: transform 0.3s; }
    .toggle.on::after { transform: translateX(18px); }
    .test-btn { font-size: 11px; padding: 4px 12px; border-radius: 4px; border: 1px solid var(--border); background: transparent; color: var(--text3); cursor: pointer; transition: all 0.2s; font-family: inherit; }
    .test-btn:hover { border-color: var(--accent); color: var(--accent); }
    .test-result { font-size: 11px; margin-top: 6px; padding: 6px 10px; border-radius: 4px; }
    .test-result.ok { background: var(--green-dim); color: var(--green); }
    .test-result.fail { background: var(--red-dim); color: var(--red); }

    /* ─── Schedule ─── */
    .schedule-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; }
    .schedule-day { background: var(--card2); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 12px 8px; text-align: center; }
    .schedule-day .day-name { font-size: 11px; font-weight: 600; color: var(--text2); text-transform: uppercase; margin-bottom: 8px; }
    .schedule-tag { display: inline-block; font-size: 10px; padding: 2px 8px; border-radius: 4px; margin: 2px; background: var(--accent-dim); color: var(--accent); cursor: pointer; }
    .schedule-tag .tag-time { font-size: 9px; color: var(--text3); display: block; }
    .schedule-tag.empty { background: transparent; color: var(--text3); border: 1px dashed var(--border); }

    /* ─── Logs ─── */
    .log-container { background: rgba(0,0,0,0.3); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 14px; max-height: 300px; overflow-y: auto; font-family: 'Consolas', monospace; font-size: 12px; line-height: 2; }
    .log-entry { display: flex; gap: 10px; }
    .log-time { color: var(--text3); white-space: nowrap; min-width: 70px; }
    .log-info { color: var(--blue); }
    .log-error { color: var(--red); }

    /* ─── History ─── */
    .history-item { display: flex; align-items: center; justify-content: space-between; padding: 14px 0; border-bottom: 1px solid var(--border); gap: 12px; }
    .history-item:last-child { border-bottom: none; }
    .history-meta { flex: 1; min-width: 0; }
    .history-time { font-size: 12px; color: var(--text3); }
    .history-strategy { font-size: 13px; font-weight: 500; margin-top: 2px; }
    .history-badges { display: flex; gap: 6px; flex-wrap: wrap; }
    .badge { font-size: 10px; padding: 3px 10px; border-radius: 4px; font-weight: 600; }
    .badge-ok { background: var(--green-dim); color: var(--green); }
    .badge-fail { background: var(--red-dim); color: var(--red); }
    .badge-manual { background: var(--blue-dim); color: var(--blue); }
    .badge-auto { background: var(--purple-dim); color: var(--purple); }
    .badge-pending { background: var(--yellow-dim); color: var(--yellow); }
    .badge-retry { background: var(--accent-dim); color: var(--accent); }

    /* ─── Queue ─── */
    .queue-item { background: var(--card2); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 16px; margin-bottom: 10px; transition: all 0.2s; }
    .queue-item:hover { border-color: var(--border2); }
    .queue-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
    .queue-strategy { font-size: 14px; font-weight: 600; }
    .queue-status { font-size: 11px; padding: 3px 10px; border-radius: 4px; font-weight: 600; }
    .queue-status.awaiting_approval { background: var(--yellow-dim); color: var(--yellow); }
    .queue-status.pending { background: var(--blue-dim); color: var(--blue); }
    .queue-status.publishing { background: var(--accent-dim); color: var(--accent); }
    .queue-status.published { background: var(--green-dim); color: var(--green); }
    .queue-status.partial { background: var(--purple-dim); color: var(--purple); }
    .queue-status.failed { background: var(--red-dim); color: var(--red); }
    .queue-status.retry { background: var(--accent-dim); color: var(--accent); }
    .queue-meta { font-size: 12px; color: var(--text3); margin-bottom: 10px; }
    .queue-platforms { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 10px; }
    .queue-actions { display: flex; gap: 8px; }

    /* ─── Scheduler Banner ─── */
    .scheduler-banner { background: linear-gradient(135deg, rgba(255,153,0,0.08), rgba(168,85,247,0.08)); border: 1px solid rgba(255,153,0,0.2); border-radius: var(--radius); padding: 20px; margin-bottom: 20px; display: flex; align-items: center; justify-content: space-between; gap: 16px; }
    .scheduler-info { flex: 1; }
    .scheduler-title { font-size: 15px; font-weight: 700; display: flex; align-items: center; gap: 10px; }
    .scheduler-title .pulse { width: 10px; height: 10px; border-radius: 50%; }
    .scheduler-title .pulse.on { background: var(--green); box-shadow: 0 0 12px var(--green); animation: pulse 2s infinite; }
    .scheduler-title .pulse.off { background: var(--text3); }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .scheduler-detail { font-size: 12px; color: var(--text2); margin-top: 6px; }
    .scheduler-next { font-size: 12px; color: var(--accent); margin-top: 4px; font-weight: 500; }

    /* ─── Spinner ─── */
    .spinner { display: inline-block; width: 14px; height: 14px; border: 2px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.7s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loading-overlay { display: flex; align-items: center; justify-content: center; padding: 40px; color: var(--text3); gap: 10px; font-size: 13px; }

    /* ─── Mobile ─── */
    .menu-toggle { display: none; background: none; border: none; color: var(--text); cursor: pointer; padding: 8px; }
    @media (max-width: 768px) {
      .sidebar { transform: translateX(-100%); }
      .sidebar.open { transform: translateX(0); box-shadow: 20px 0 60px rgba(0,0,0,0.5); }
      .main { margin-left: 0; }
      .menu-toggle { display: block; }
      .topbar { padding: 12px 16px; }
      .page { padding: 16px; }
      .form-row { grid-template-columns: 1fr; }
      .schedule-grid { grid-template-columns: repeat(4, 1fr); }
      .grid-4 { grid-template-columns: repeat(2, 1fr); }
      .scheduler-banner { flex-direction: column; text-align: center; }
    }

    .img-preview { text-align: center; margin-top: 16px; }
    .img-preview img { max-width: 320px; border-radius: var(--radius-sm); border: 1px solid var(--border); box-shadow: 0 8px 24px rgba(0,0,0,0.3); }
    .empty { text-align: center; padding: 40px 20px; color: var(--text3); }
    .empty svg { width: 48px; height: 48px; margin-bottom: 12px; opacity: 0.3; }
    .empty p { font-size: 13px; }

    .toast { position: fixed; bottom: 24px; right: 24px; padding: 12px 20px; border-radius: var(--radius-sm); font-size: 13px; font-weight: 500; z-index: 999; animation: toastIn 0.3s; display: none; }
    .toast.show { display: flex; align-items: center; gap: 8px; }
    .toast.ok { background: var(--green); color: #000; }
    .toast.fail { background: var(--red); color: #fff; }
    @keyframes toastIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body>

<!-- Sidebar -->
<aside class="sidebar" id="sidebar">
  <div class="sidebar-brand">
    <h1><span class="dot"></span> x402 Agent</h1>
    <p>Community Manager IA</p>
  </div>
  <nav class="sidebar-nav">
    <div class="nav-item active" data-page="dashboard" onclick="navigateTo('dashboard')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
      Tableau de bord
    </div>
    <div class="nav-item" data-page="automation" onclick="navigateTo('automation')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M12 1v4M12 19v4M4.22 4.22l2.83 2.83M16.95 16.95l2.83 2.83M1 12h4M19 12h4M4.22 19.78l2.83-2.83M16.95 7.05l2.83-2.83"/></svg>
      Automatisation
      <span class="nav-badge" id="nav-queue-badge" style="display:none">0</span>
    </div>
    <div class="nav-item" data-page="studio" onclick="navigateTo('studio')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 013 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
      Studio de contenu
    </div>
    <div class="nav-item" data-page="settings" onclick="navigateTo('settings')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 01-2.83 2.83l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
      Configuration
    </div>
    <div class="nav-item" data-page="history" onclick="navigateTo('history')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
      Historique
    </div>
    <div class="nav-item" data-page="logs" onclick="navigateTo('logs')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
      Journaux
    </div>
  </nav>
  <div class="sidebar-footer">
    <div class="budget">Budget restant</div>
    <div class="budget-val" id="sidebar-budget">-- USDC</div>
  </div>
</aside>

<!-- Main -->
<div class="main">
  <div class="topbar">
    <div style="display:flex;align-items:center;gap:12px">
      <button class="menu-toggle" onclick="document.getElementById('sidebar').classList.toggle('open')">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
      </button>
      <h2 id="page-title">Tableau de bord</h2>
    </div>
    <div class="topbar-stats">
      <div class="topbar-stat"><div class="v" id="t-apis">--</div><div class="l">APIs</div></div>
      <div class="topbar-stat"><div class="v" id="t-uptime">--</div><div class="l">Uptime</div></div>
      <div class="topbar-stat"><div class="v" id="t-calls">--</div><div class="l">Appels 24h</div></div>
    </div>
  </div>

  <!-- ========== PAGE: Dashboard ========== -->
  <div class="page active" id="page-dashboard">
    <!-- Scheduler Banner -->
    <div class="scheduler-banner" id="dash-scheduler">
      <div class="scheduler-info">
        <div class="scheduler-title"><span class="pulse off" id="dash-sched-pulse"></span> Scheduler <span id="dash-sched-label" style="font-weight:400;font-size:12px;color:var(--text3)">inactif</span></div>
        <div class="scheduler-next" id="dash-sched-next"></div>
      </div>
      <button class="btn btn-accent btn-sm" id="dash-sched-btn" onclick="toggleScheduler()">Activer</button>
    </div>

    <div class="grid-4" id="stats-grid" style="margin-bottom:24px">
      <div class="stat-card"><div class="val" id="s-apis">--</div><div class="lbl">APIs actives</div></div>
      <div class="stat-card"><div class="val" id="s-uptime">--</div><div class="lbl">Disponibilite</div></div>
      <div class="stat-card"><div class="val" id="s-payments">--</div><div class="lbl">Paiements</div></div>
      <div class="stat-card"><div class="val" id="s-queue">0</div><div class="lbl">File d'attente</div></div>
    </div>

    <div class="grid-2">
      <div class="card">
        <div class="card-header"><span class="card-title">Plateformes</span></div>
        <div id="dash-platforms" class="grid-2" style="gap:10px"></div>
      </div>
      <div class="card">
        <div class="card-header"><span class="card-title">Top APIs</span></div>
        <div id="dash-top"></div>
      </div>
    </div>

    <div class="card">
      <div class="card-header"><span class="card-title">Activite recente</span></div>
      <div class="log-container" id="dash-logs" style="max-height:200px">
        <div class="loading-overlay"><span class="spinner"></span> Chargement...</div>
      </div>
    </div>
  </div>

  <!-- ========== PAGE: Automation ========== -->
  <div class="page" id="page-automation">
    <!-- Scheduler Controls -->
    <div class="card">
      <div class="card-header">
        <span class="card-title">Moteur d'automatisation</span>
        <div style="display:flex;gap:8px;align-items:center">
          <span class="pulse off" id="auto-sched-pulse" style="width:8px;height:8px;border-radius:50%;display:inline-block"></span>
          <span id="auto-sched-status" style="font-size:12px;color:var(--text3)">Inactif</span>
        </div>
      </div>
      <div class="grid-3" style="margin-bottom:20px">
        <div class="stat-card">
          <div class="val" id="auto-next-time">--</div>
          <div class="lbl">Prochain post</div>
        </div>
        <div class="stat-card">
          <div class="val" id="auto-queue-count">0</div>
          <div class="lbl">En file d'attente</div>
        </div>
        <div class="stat-card">
          <div class="val" id="auto-pending-count">0</div>
          <div class="lbl">En attente d'approbation</div>
        </div>
      </div>
      <div class="btn-row">
        <button class="btn btn-green" id="auto-start-btn" onclick="toggleScheduler()">Demarrer le scheduler</button>
        <button class="btn btn-accent" onclick="runNow()">Executer maintenant</button>
        <select class="form-input" id="run-now-strategy" style="width:180px;padding:8px 12px">
          <option value="daily-stats">Stats du jour</option>
          <option value="weekly-recap">Recap hebdo</option>
          <option value="new-api">Nouvelle API</option>
        </select>
      </div>
    </div>

    <!-- Webhook Info -->
    <div class="card">
      <div class="card-header"><span class="card-title">Webhook — Nouvelle API</span></div>
      <p style="font-size:13px;color:var(--text2);margin-bottom:12px">Quand une nouvelle API est enregistree sur x402 Bazaar, envoyez un POST pour declencher automatiquement une annonce.</p>
      <div style="background:rgba(0,0,0,0.3);border:1px solid var(--border);border-radius:var(--radius-sm);padding:14px;font-family:'Consolas',monospace;font-size:12px;color:var(--accent)">
        POST /api/webhook/new-api<br>
        Content-Type: application/json<br><br>
        {<br>
        &nbsp;&nbsp;"apiName": "Weather API",<br>
        &nbsp;&nbsp;"apiDescription": "Real-time weather data",<br>
        &nbsp;&nbsp;"apiPrice": "0.001 USDC"<br>
        }
      </div>
    </div>

    <!-- Queue -->
    <div class="card">
      <div class="card-header">
        <span class="card-title">File d'attente</span>
        <button class="btn btn-ghost btn-sm" onclick="loadQueue()">Rafraichir</button>
      </div>
      <div id="queue-list">
        <div class="empty"><p>Aucun element en file d'attente</p></div>
      </div>
    </div>
  </div>

  <!-- ========== PAGE: Studio ========== -->
  <div class="page" id="page-studio">
    <div class="card">
      <div class="card-header"><span class="card-title">Strategie de contenu</span></div>
      <div class="pills" id="pills">
        <button class="pill active" data-s="daily-stats">Stats du jour</button>
        <button class="pill" data-s="weekly-recap">Recap hebdo</button>
        <button class="pill" data-s="new-api">Nouvelle API</button>
      </div>
      <div class="btn-row">
        <button class="btn btn-accent" id="btn-gen" onclick="doGenerate()">Generer l'apercu</button>
        <button class="btn btn-ghost" id="btn-tg" onclick="doSendTelegram()" disabled>Envoyer sur Telegram</button>
        <button class="btn btn-green" id="btn-pub" onclick="doPublish()" disabled>Publier</button>
      </div>
    </div>
    <div id="studio-preview" style="display:none">
      <div class="card">
        <div class="card-header"><span class="card-title">Apercu par plateforme</span></div>
        <div class="checks" id="pub-checks"></div>
        <div class="tabs" id="prev-tabs"></div>
        <div class="tab-content" id="prev-content">Selectionnez un onglet...</div>
        <div class="img-preview" id="prev-img"></div>
      </div>
    </div>
  </div>

  <!-- ========== PAGE: Settings ========== -->
  <div class="page" id="page-settings">
    <div class="card">
      <div class="card-header"><span class="card-title">Portefeuille Agent</span></div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Cle privee</label>
          <input class="form-input" type="password" id="set-wallet-key" placeholder="0x...">
          <div class="form-hint">Cle privee du wallet agent sur Base (USDC)</div>
        </div>
        <div class="form-group">
          <label class="form-label">Budget max (USDC)</label>
          <input class="form-input" type="number" id="set-wallet-budget" step="0.01" value="0.50">
          <div class="form-hint">Budget maximum par session</div>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="card-header"><span class="card-title">Contenu</span></div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Nom du projet</label>
          <input class="form-input" id="set-project-name" value="x402 Bazaar">
        </div>
        <div class="form-group">
          <label class="form-label">URL du projet</label>
          <input class="form-input" id="set-project-url" value="https://x402bazaar.org">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Langue</label>
          <select class="form-input" id="set-lang">
            <option value="fr">Francais</option>
            <option value="en">Anglais</option>
          </select>
        </div>
        <div class="form-group" style="display:flex;align-items:end;gap:12px;padding-bottom:4px">
          <label class="form-label" style="margin:0">Generer des images</label>
          <div class="toggle on" id="set-images" onclick="this.classList.toggle('on')"></div>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="card-header"><span class="card-title">Scheduler</span></div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Heure par defaut</label>
          <input class="form-input" type="time" id="set-default-time" value="09:00">
          <div class="form-hint">Heure de publication par defaut</div>
        </div>
        <div class="form-group">
          <label class="form-label">Tentatives max (retry)</label>
          <input class="form-input" type="number" id="set-retry-max" value="3" min="0" max="10">
          <div class="form-hint">Nombre max de tentatives en cas d'echec</div>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="card-header"><span class="card-title">Plateformes</span></div>
      <div id="settings-platforms"></div>
    </div>
    <div class="card">
      <div class="card-header"><span class="card-title">Calendrier editorial</span></div>
      <div class="schedule-grid" id="schedule-grid"></div>
      <div class="form-hint" style="margin-top:10px">Cliquez sur une case pour modifier le planning. Le format est {strategie}@{heure}.</div>
    </div>
    <div class="btn-row" style="margin-top:8px">
      <button class="btn btn-accent" onclick="saveAllSettings()">Sauvegarder la configuration</button>
      <button class="btn btn-ghost" onclick="loadAllSettings()">Reinitialiser</button>
    </div>
  </div>

  <!-- ========== PAGE: History ========== -->
  <div class="page" id="page-history">
    <div class="card">
      <div class="card-header"><span class="card-title">Publications recentes</span></div>
      <div id="history-list">
        <div class="loading-overlay"><span class="spinner"></span> Chargement...</div>
      </div>
    </div>
  </div>

  <!-- ========== PAGE: Logs ========== -->
  <div class="page" id="page-logs">
    <div class="card">
      <div class="card-header">
        <span class="card-title">Journaux d'activite</span>
        <button class="btn btn-ghost btn-sm" onclick="loadLogs()">Rafraichir</button>
      </div>
      <div class="log-container" id="logs-full" style="max-height:500px">
        <div class="loading-overlay"><span class="spinner"></span> Chargement...</div>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
const PLATFORMS = {
  telegram: { label: 'Telegram', icon: '&#9992;', color: '#0088cc', fields: [
    { key: 'botToken', label: 'Token du bot', type: 'password', hint: 'Token de @BotFather' },
    { key: 'adminChatId', label: 'Chat ID admin', hint: 'Votre chat ID personnel' },
    { key: 'channelId', label: 'ID du channel public', hint: 'Ex: @x402_updates' },
  ]},
  discord: { label: 'Discord', icon: '&#127918;', color: '#5865f2', fields: [
    { key: 'webhookUrl', label: 'URL du webhook', type: 'password', hint: 'Parametres > Integrations > Webhooks' },
  ]},
  twitter: { label: 'Twitter / X', icon: '&#120143;', color: '#1da1f2', fields: [
    { key: 'apiKey', label: 'API Key', type: 'password' },
    { key: 'apiSecret', label: 'API Secret', type: 'password' },
    { key: 'accessToken', label: 'Access Token', type: 'password' },
    { key: 'accessSecret', label: 'Access Secret', type: 'password' },
  ]},
  reddit: { label: 'Reddit', icon: '&#129302;', color: '#ff4500', fields: [
    { key: 'clientId', label: 'Client ID' },
    { key: 'clientSecret', label: 'Client Secret', type: 'password' },
    { key: 'username', label: "Nom d'utilisateur" },
    { key: 'password', label: 'Mot de passe', type: 'password' },
  ]},
  devto: { label: 'Dev.to', icon: '&#128221;', color: '#0a0a0a', fields: [
    { key: 'apiKey', label: 'Cle API', type: 'password', hint: 'dev.to/settings/extensions' },
  ]},
  linkedin: { label: 'LinkedIn', icon: '&#128188;', color: '#0077b5', fields: [
    { key: 'accessToken', label: "Token d'acces OAuth2", type: 'password' },
  ]},
  farcaster: { label: 'Farcaster', icon: '&#128995;', color: '#8b5cf6', fields: [
    { key: 'mnemonic', label: 'Mnemonique', type: 'password', hint: '12 ou 24 mots' },
  ]},
  hn: { label: 'Hacker News', icon: '&#128992;', color: '#ff6600', fields: [] },
};
const STRATEGY_LABELS = { 'daily-stats': 'Stats du jour', 'weekly-recap': 'Recap hebdo', 'new-api': 'Nouvelle API' };
const DAYS = { monday: 'Lun', tuesday: 'Mar', wednesday: 'Mer', thursday: 'Jeu', friday: 'Ven', saturday: 'Sam', sunday: 'Dim' };
const STATUS_LABELS = { awaiting_approval: 'En attente', pending: 'En attente', publishing: 'Publication...', published: 'Publie', partial: 'Partiel', failed: 'Echoue', retry: 'Retry' };

let currentPage = 'dashboard';
let currentStrategy = 'daily-stats';
let previewData = null;
let settingsCache = null;
let schedulerData = null;

// ─── Navigation ──────────────────────────────────────────────────
function navigateTo(page) {
  currentPage = page;
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById('page-' + page).classList.add('active');
  document.querySelectorAll('.nav-item').forEach(n => n.classList.toggle('active', n.dataset.page === page));
  const titles = { dashboard: 'Tableau de bord', automation: 'Automatisation', studio: 'Studio de contenu', settings: 'Configuration', history: 'Historique', logs: 'Journaux' };
  document.getElementById('page-title').textContent = titles[page] || page;
  document.getElementById('sidebar').classList.remove('open');
  if (page === 'settings' && !settingsCache) loadAllSettings();
  if (page === 'history') loadHistory();
  if (page === 'logs') loadLogs();
  if (page === 'automation') { loadSchedulerStatus(); loadQueue(); }
}

// ─── API ─────────────────────────────────────────────────────────
async function api(url, opts = {}) {
  const res = await fetch(url, { headers: { 'Content-Type': 'application/json' }, ...opts });
  if (!res.ok) { const e = await res.json().catch(() => ({})); throw new Error(e.error || `HTTP ${res.status}`); }
  return res.json();
}

function toast(msg, type = 'ok') {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.className = `toast show ${type}`;
  setTimeout(() => el.className = 'toast', 3000);
}

function formatTime(iso) {
  if (!iso) return '--';
  const d = new Date(iso);
  return d.toLocaleString('fr-FR', { weekday: 'short', hour: '2-digit', minute: '2-digit' });
}

function formatCountdown(iso) {
  if (!iso) return '--';
  const diff = new Date(iso) - Date.now();
  if (diff < 0) return 'Imminent';
  const h = Math.floor(diff / 3600000);
  const m = Math.floor((diff % 3600000) / 60000);
  if (h > 24) return `${Math.floor(h / 24)}j ${h % 24}h`;
  if (h > 0) return `${h}h ${m}min`;
  return `${m}min`;
}

// ─── Dashboard ───────────────────────────────────────────────────
async function loadDashboard() {
  const [status, stats, sched] = await Promise.all([api('/api/status'), api('/api/stats'), api('/api/scheduler')]);
  schedulerData = sched;

  document.getElementById('t-apis').textContent = stats.totalServices || 0;
  document.getElementById('t-uptime').textContent = `${stats.uptimePercent || 0}%`;
  document.getElementById('t-calls').textContent = stats.recentCalls24h || 0;
  document.getElementById('s-apis').textContent = stats.totalServices || 0;
  document.getElementById('s-uptime').textContent = `${stats.uptimePercent || 0}%`;
  document.getElementById('s-payments').textContent = stats.totalPayments || 0;
  document.getElementById('s-queue').textContent = status.queueLength || 0;
  document.getElementById('sidebar-budget').textContent = `${status.budget.remaining.toFixed(2)} USDC`;

  // Scheduler banner
  const running = sched.running;
  document.getElementById('dash-sched-pulse').className = `pulse ${running ? 'on' : 'off'}`;
  document.getElementById('dash-sched-label').textContent = running ? 'actif' : 'inactif';
  document.getElementById('dash-sched-btn').textContent = running ? 'Arreter' : 'Activer';
  document.getElementById('dash-sched-btn').className = `btn btn-sm ${running ? 'btn-red' : 'btn-green'}`;
  const next = sched.nextPost;
  document.getElementById('dash-sched-next').textContent = next ? `Prochain post: ${STRATEGY_LABELS[next.strategy] || next.strategy} dans ${formatCountdown(next.time)} (${next.hour})` : 'Aucun post planifie';

  // Queue badge
  const pending = sched.pendingApproval || 0;
  const badge = document.getElementById('nav-queue-badge');
  if (pending > 0) { badge.textContent = pending; badge.style.display = 'inline'; }
  else { badge.style.display = 'none'; }

  // Platforms
  const el = document.getElementById('dash-platforms');
  el.innerHTML = Object.entries(status.platforms).map(([k, v]) => {
    const p = PLATFORMS[k] || {};
    return `<div class="platform-card">
      <div class="platform-icon" style="background:${p.color}22;color:${p.color}">${p.icon || '?'}</div>
      <div class="platform-info">
        <div class="platform-name">${p.label || k}</div>
        <div class="platform-status ${v.enabled ? 'on' : 'off'}"><span class="status-dot ${v.enabled ? 'on' : 'off'}"></span>${v.enabled ? 'Connecte' : 'Non configure'}</div>
      </div>
    </div>`;
  }).join('');

  // Top APIs
  const topEl = document.getElementById('dash-top');
  const tops = (stats.topEndpoints || []).slice(0, 6);
  topEl.innerHTML = tops.length === 0 ? '<div class="empty"><p>Aucune donnee</p></div>' :
    tops.map((t, i) => `<div style="display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border)">
      <div style="display:flex;align-items:center;gap:10px"><span style="font-size:12px;color:var(--text3);width:18px">${i + 1}.</span><span style="font-size:13px">${t.endpoint}</span></div>
      <span style="font-size:12px;font-weight:600;color:var(--accent)">${t.count} appels</span>
    </div>`).join('');

  loadDashLogs();
}

async function loadDashLogs() {
  try {
    const logs = await api('/api/logs');
    document.getElementById('dash-logs').innerHTML = logs.slice(-8).map(l =>
      `<div class="log-entry"><span class="log-time">${l.time.slice(11, 19)}</span><span class="log-${l.level}">${l.msg}</span></div>`
    ).join('') || '<div style="color:var(--text3);padding:12px">Aucun journal</div>';
  } catch {}
}

// ─── Scheduler Controls ──────────────────────────────────────────
async function toggleScheduler() {
  try {
    const sched = schedulerData || await api('/api/scheduler');
    if (sched.running) {
      await api('/api/scheduler/stop', { method: 'POST' });
      toast('Scheduler arrete');
    } else {
      await api('/api/scheduler/start', { method: 'POST' });
      toast('Scheduler demarre');
    }
    loadDashboard();
    if (currentPage === 'automation') loadSchedulerStatus();
  } catch (e) { toast('Erreur: ' + e.message, 'fail'); }
}

async function loadSchedulerStatus() {
  try {
    const sched = await api('/api/scheduler');
    schedulerData = sched;
    const running = sched.running;

    document.getElementById('auto-sched-pulse').className = `pulse ${running ? 'on' : 'off'}`;
    document.getElementById('auto-sched-status').textContent = running ? 'Actif' : 'Inactif';
    document.getElementById('auto-sched-status').style.color = running ? 'var(--green)' : 'var(--text3)';
    document.getElementById('auto-start-btn').textContent = running ? 'Arreter le scheduler' : 'Demarrer le scheduler';
    document.getElementById('auto-start-btn').className = `btn ${running ? 'btn-red' : 'btn-green'}`;

    document.getElementById('auto-next-time').textContent = sched.nextPost ? formatCountdown(sched.nextPost.time) : '--';
    document.getElementById('auto-queue-count').textContent = sched.queueLength;
    document.getElementById('auto-pending-count').textContent = sched.pendingApproval;
  } catch {}
}

async function runNow() {
  const strategy = document.getElementById('run-now-strategy').value;
  try {
    toast('Execution en cours...', 'ok');
    await api('/api/scheduler/run-now', { method: 'POST', body: JSON.stringify({ strategy }) });
    toast(`${STRATEGY_LABELS[strategy]} execute`);
    loadQueue();
    loadSchedulerStatus();
  } catch (e) { toast('Erreur: ' + e.message, 'fail'); }
}

// ─── Queue ────────────────────────────────────────────────────────
async function loadQueue() {
  try {
    const items = await api('/api/queue');
    const el = document.getElementById('queue-list');
    if (items.length === 0) {
      el.innerHTML = '<div class="empty"><p>Aucun element en file d\'attente</p></div>';
      return;
    }
    el.innerHTML = items.map(q => {
      const platformBadges = q.platforms.map(p =>
        `<span class="badge ${q.results[p]?.success ? 'badge-ok' : (q.results[p] ? 'badge-fail' : 'badge-pending')}">${PLATFORMS[p]?.icon || ''} ${PLATFORMS[p]?.label || p}</span>`
      ).join('');

      let actions = '';
      if (q.status === 'awaiting_approval') {
        actions = `<button class="btn btn-green btn-xs" onclick="approveQueue('${q.id}')">Approuver</button>
          <button class="btn btn-red btn-xs" onclick="deleteQueue('${q.id}')">Rejeter</button>`;
      } else if (q.status === 'failed') {
        actions = `<button class="btn btn-accent btn-xs" onclick="retryQueue('${q.id}')">Retenter</button>
          <button class="btn btn-red btn-xs" onclick="deleteQueue('${q.id}')">Supprimer</button>`;
      } else if (q.status === 'retry') {
        const nextRetry = q.nextRetry ? `Retry dans ${formatCountdown(q.nextRetry)}` : '';
        actions = `<span style="font-size:11px;color:var(--accent)">${nextRetry}</span>
          <button class="btn btn-red btn-xs" onclick="deleteQueue('${q.id}')">Annuler</button>`;
      } else if (q.status === 'published' || q.status === 'partial') {
        actions = `<button class="btn btn-ghost btn-xs" onclick="deleteQueue('${q.id}')">Archiver</button>`;
      }

      return `<div class="queue-item">
        <div class="queue-header">
          <div>
            <span class="queue-strategy">${STRATEGY_LABELS[q.strategy] || q.strategy}</span>
            ${q.autoPublish ? '<span class="badge badge-auto" style="margin-left:8px">Auto</span>' : '<span class="badge badge-pending" style="margin-left:8px">Manuel</span>'}
          </div>
          <span class="queue-status ${q.status}">${STATUS_LABELS[q.status] || q.status}</span>
        </div>
        <div class="queue-meta">
          Cree: ${new Date(q.createdAt).toLocaleString('fr-FR')}
          ${q.publishedAt ? ` | Publie: ${new Date(q.publishedAt).toLocaleString('fr-FR')}` : ''}
          ${q.retryCount > 0 ? ` | Tentatives: ${q.retryCount}` : ''}
        </div>
        <div class="queue-platforms">${platformBadges}</div>
        <div class="queue-actions">${actions}</div>
      </div>`;
    }).join('');
  } catch (e) {
    document.getElementById('queue-list').innerHTML = '<div class="empty"><p>Erreur de chargement</p></div>';
  }
}

async function approveQueue(id) {
  try {
    await api(`/api/queue/${id}/approve`, { method: 'POST' });
    toast('Publication approuvee');
    loadQueue();
    loadSchedulerStatus();
  } catch (e) { toast('Erreur: ' + e.message, 'fail'); }
}

async function retryQueue(id) {
  try {
    await api(`/api/queue/${id}/retry`, { method: 'POST' });
    toast('Retry lance');
    loadQueue();
  } catch (e) { toast('Erreur: ' + e.message, 'fail'); }
}

async function deleteQueue(id) {
  try {
    await api(`/api/queue/${id}`, { method: 'DELETE' });
    toast('Element supprime');
    loadQueue();
    loadSchedulerStatus();
  } catch (e) { toast('Erreur: ' + e.message, 'fail'); }
}

// ─── Studio ──────────────────────────────────────────────────────
document.getElementById('pills').addEventListener('click', e => {
  if (!e.target.dataset.s) return;
  document.querySelectorAll('.pill').forEach(p => p.classList.remove('active'));
  e.target.classList.add('active');
  currentStrategy = e.target.dataset.s;
});

async function doGenerate() {
  const btn = document.getElementById('btn-gen');
  btn.disabled = true; btn.innerHTML = '<span class="spinner"></span> Generation...';
  try {
    previewData = await api('/api/preview', { method: 'POST', body: JSON.stringify({ strategy: currentStrategy }) });
    renderPreview();
    document.getElementById('studio-preview').style.display = 'block';
    document.getElementById('btn-tg').disabled = false;
    document.getElementById('btn-pub').disabled = false;
    toast('Contenu genere avec succes');
  } catch (e) { toast('Erreur: ' + e.message, 'fail'); }
  btn.disabled = false; btn.innerHTML = 'Generer l\'apercu';
}

function renderPreview() {
  if (!previewData) return;
  const platforms = Object.keys(previewData.contents);
  document.getElementById('prev-tabs').innerHTML = platforms.map((p, i) =>
    `<button class="tab ${i === 0 ? 'active' : ''}" onclick="showTab('${p}')">${(PLATFORMS[p]?.icon || '') + ' ' + (PLATFORMS[p]?.label || p)}</button>`
  ).join('');
  document.getElementById('pub-checks').innerHTML = platforms.map(p =>
    `<label class="check-item checked" onclick="this.classList.toggle('checked')"><input type="checkbox" value="${p}" checked> ${PLATFORMS[p]?.icon || ''} ${PLATFORMS[p]?.label || p}</label>`
  ).join('');
  if (platforms.length > 0) showTab(platforms[0]);
  document.getElementById('prev-img').innerHTML = previewData.imageUrl ? `<img src="${previewData.imageUrl}" alt="Visuel genere">` : '';
}

function showTab(platform) {
  document.querySelectorAll('#prev-tabs .tab').forEach(t => t.classList.toggle('active', t.textContent.includes(PLATFORMS[platform]?.label || platform)));
  const c = previewData.contents[platform];
  document.getElementById('prev-content').textContent = typeof c === 'string' ? c : JSON.stringify(c, null, 2);
}

async function doSendTelegram() {
  if (!previewData) return;
  const btn = document.getElementById('btn-tg');
  btn.disabled = true; btn.innerHTML = '<span class="spinner"></span> Envoi...';
  try {
    await api('/api/telegram-preview', { method: 'POST', body: JSON.stringify({ contents: previewData.contents, imageUrl: previewData.imageUrl }) });
    toast('Apercu envoye sur Telegram');
  } catch (e) { toast('Erreur: ' + e.message, 'fail'); }
  btn.disabled = false; btn.innerHTML = 'Envoyer sur Telegram';
}

async function doPublish() {
  if (!previewData) return;
  const checked = [...document.querySelectorAll('#pub-checks .check-item.checked input')].map(c => c.value);
  if (checked.length === 0) { toast('Selectionnez au moins une plateforme', 'fail'); return; }
  if (!confirm(`Publier sur ${checked.map(p => PLATFORMS[p]?.label || p).join(', ')} ?`)) return;
  const btn = document.getElementById('btn-pub');
  btn.disabled = true; btn.innerHTML = '<span class="spinner"></span> Publication...';
  try {
    const result = await api('/api/publish', { method: 'POST', body: JSON.stringify({ contents: previewData.contents, imageUrl: previewData.imageUrl, platforms: checked, strategy: currentStrategy }) });
    const ok = Object.values(result.results).filter(r => r.success).length;
    const total = Object.keys(result.results).length;
    toast(`Publie: ${ok}/${total} plateformes`);
  } catch (e) { toast('Erreur: ' + e.message, 'fail'); }
  btn.disabled = false; btn.innerHTML = 'Publier';
}

// ─── Settings ────────────────────────────────────────────────────
async function loadAllSettings() {
  try {
    settingsCache = await api('/api/settings');
    renderSettings();
  } catch (e) { toast('Erreur chargement config: ' + e.message, 'fail'); }
}

function renderSettings() {
  const s = settingsCache;
  document.getElementById('set-wallet-key').value = s.wallet.privateKey || '';
  document.getElementById('set-wallet-budget').value = s.wallet.maxBudget;
  document.getElementById('set-project-name').value = s.content.projectName;
  document.getElementById('set-project-url').value = s.content.projectUrl;
  document.getElementById('set-lang').value = s.content.defaultLanguage;
  document.getElementById('set-images').classList.toggle('on', s.content.generateImages);
  document.getElementById('set-default-time').value = s.scheduler?.defaultTime || '09:00';
  document.getElementById('set-retry-max').value = s.scheduler?.retryMax ?? 3;

  // Platforms
  const container = document.getElementById('settings-platforms');
  container.innerHTML = Object.entries(PLATFORMS).map(([key, p]) => {
    const cfg = s.platforms[key] || {};
    const fieldsHtml = p.fields.map(f => `
      <div class="form-group">
        <label class="form-label">${f.label}</label>
        <input class="form-input platform-field" type="${f.type || 'text'}" data-platform="${key}" data-key="${f.key}" value="${cfg[f.key] || ''}" placeholder="${f.hint || ''}">
        ${f.hint ? `<div class="form-hint">${f.hint}</div>` : ''}
      </div>`).join('');

    return `<div class="form-section">
      <div class="form-section-header">
        <div class="form-section-title">
          <span style="font-size:20px">${p.icon}</span> ${p.label}
          <button class="test-btn" onclick="testPlatform('${key}', this)">Tester</button>
        </div>
        <div style="display:flex;align-items:center;gap:12px">
          <div style="display:flex;align-items:center;gap:6px">
            <span style="font-size:10px;color:var(--text3)">Auto</span>
            <div class="toggle ${cfg.autoPublish ? 'on' : ''}" data-platform-auto="${key}" onclick="this.classList.toggle('on')" title="Publication automatique"></div>
          </div>
          <div class="toggle ${cfg.enabled ? 'on' : ''}" data-platform-toggle="${key}" onclick="this.classList.toggle('on')"></div>
        </div>
      </div>
      ${fieldsHtml ? `<div class="form-row">${fieldsHtml}</div>` : '<div class="form-hint">Aucune configuration necessaire</div>'}
      <div id="test-result-${key}"></div>
    </div>`;
  }).join('');

  // Schedule
  renderScheduleGrid();
}

function renderScheduleGrid() {
  const s = settingsCache;
  const scheduleEl = document.getElementById('schedule-grid');
  scheduleEl.innerHTML = Object.entries(DAYS).map(([dayKey, dayLabel]) => {
    const strats = s.schedule[dayKey] || [];
    const tags = strats.map((st, i) => {
      const name = typeof st === 'string' ? st : st.strategy;
      const time = typeof st === 'string' ? (s.scheduler?.defaultTime || '09:00') : st.time;
      return `<div class="schedule-tag" onclick="editScheduleEntry('${dayKey}', ${i})" title="Cliquer pour modifier">
        ${STRATEGY_LABELS[name] || name}<span class="tag-time">${time}</span>
      </div>`;
    });
    return `<div class="schedule-day">
      <div class="day-name">${dayLabel}</div>
      ${tags.length > 0 ? tags.join('') : '<div class="schedule-tag empty" onclick="addScheduleEntry(\''+dayKey+'\')">+ Ajouter</div>'}
      ${tags.length > 0 ? '<div class="schedule-tag empty" onclick="addScheduleEntry(\''+dayKey+'\')" style="margin-top:4px">+</div>' : ''}
    </div>`;
  }).join('');
}

function editScheduleEntry(day, index) {
  const entries = settingsCache.schedule[day] || [];
  const entry = entries[index];
  const name = typeof entry === 'string' ? entry : entry.strategy;
  const time = typeof entry === 'string' ? '09:00' : entry.time;

  const choice = prompt(`Modifier (ou "supprimer" pour retirer):\nStrategie: daily-stats, weekly-recap, new-api\nFormat: strategie@heure (ex: daily-stats@10:30)`, `${name}@${time}`);
  if (choice === null) return;
  if (choice.toLowerCase() === 'supprimer' || choice === '') {
    entries.splice(index, 1);
  } else {
    const [s, t] = choice.split('@');
    entries[index] = { strategy: s.trim(), time: t?.trim() || '09:00' };
  }
  settingsCache.schedule[day] = entries;
  renderScheduleGrid();
}

function addScheduleEntry(day) {
  const choice = prompt('Ajouter une strategie:\nFormat: strategie@heure (ex: daily-stats@09:00)', 'daily-stats@09:00');
  if (!choice) return;
  const [s, t] = choice.split('@');
  if (!settingsCache.schedule[day]) settingsCache.schedule[day] = [];
  settingsCache.schedule[day].push({ strategy: s.trim(), time: t?.trim() || '09:00' });
  renderScheduleGrid();
}

async function testPlatform(platform, btn) {
  const el = document.getElementById('test-result-' + platform);
  btn.textContent = '...';
  try {
    const result = await api(`/api/settings/test/${platform}`);
    el.innerHTML = `<div class="test-result ${result.success ? 'ok' : 'fail'}">${result.success ? 'Connecte' : 'Echec'}: ${result.message}</div>`;
  } catch (e) { el.innerHTML = `<div class="test-result fail">Erreur: ${e.message}</div>`; }
  btn.textContent = 'Tester';
}

async function saveAllSettings() {
  const settings = {
    wallet: {
      privateKey: document.getElementById('set-wallet-key').value,
      maxBudget: parseFloat(document.getElementById('set-wallet-budget').value) || 0.5,
    },
    platforms: {},
    content: {
      generateImages: document.getElementById('set-images').classList.contains('on'),
      defaultLanguage: document.getElementById('set-lang').value,
      projectName: document.getElementById('set-project-name').value,
      projectUrl: document.getElementById('set-project-url').value,
    },
    scheduler: {
      enabled: schedulerData?.running || false,
      defaultTime: document.getElementById('set-default-time').value || '09:00',
      retryMax: parseInt(document.getElementById('set-retry-max').value) || 3,
      retryDelays: [5, 30, 60],
    },
    schedule: settingsCache.schedule,
  };

  Object.keys(PLATFORMS).forEach(key => {
    const enabled = document.querySelector(`[data-platform-toggle="${key}"]`)?.classList.contains('on') || false;
    const autoPublish = document.querySelector(`[data-platform-auto="${key}"]`)?.classList.contains('on') || false;
    const fields = {};
    document.querySelectorAll(`.platform-field[data-platform="${key}"]`).forEach(input => {
      const val = input.value.trim();
      if (val && !val.startsWith('***')) {
        fields[input.dataset.key] = val;
      } else if (settingsCache?.platforms?.[key]?.[input.dataset.key]) {
        fields[input.dataset.key] = '___KEEP___';
      }
    });
    settings.platforms[key] = { enabled, autoPublish, ...fields };
    if (key === 'reddit') settings.platforms[key].subreddits = settingsCache?.platforms?.reddit?.subreddits || ['artificial', 'webdev', 'SideProject'];
  });

  try {
    await api('/api/settings', { method: 'POST', body: JSON.stringify(settings) });
    toast('Configuration sauvegardee');
    loadDashboard();
  } catch (e) { toast('Erreur: ' + e.message, 'fail'); }
}

// ─── History ─────────────────────────────────────────────────────
async function loadHistory() {
  try {
    const items = await api('/api/history');
    const el = document.getElementById('history-list');
    if (items.length === 0) { el.innerHTML = '<div class="empty"><p>Aucune publication pour le moment</p></div>'; return; }
    el.innerHTML = items.slice().reverse().map(h => {
      const badges = Object.entries(h.results).map(([p, r]) =>
        `<span class="badge ${r.success ? 'badge-ok' : (r.manualPost ? 'badge-manual' : 'badge-fail')}">${PLATFORMS[p]?.icon || ''} ${PLATFORMS[p]?.label || p}</span>`
      ).join('');
      return `<div class="history-item">
        <div class="history-meta">
          <div class="history-time">${new Date(h.time).toLocaleString('fr-FR')}${h.auto ? ' <span class="badge badge-auto">Auto</span>' : ''}</div>
          <div class="history-strategy">${STRATEGY_LABELS[h.strategy] || h.strategy || 'Inconnu'}</div>
        </div>
        <div class="history-badges">${badges}</div>
      </div>`;
    }).join('');
  } catch (e) { document.getElementById('history-list').innerHTML = '<div class="empty"><p>Erreur de chargement</p></div>'; }
}

// ─── Logs ────────────────────────────────────────────────────────
async function loadLogs() {
  try {
    const logs = await api('/api/logs');
    const el = document.getElementById('logs-full');
    el.innerHTML = logs.map(l =>
      `<div class="log-entry"><span class="log-time">${l.time.slice(11, 19)}</span><span class="log-${l.level}">${l.msg}</span></div>`
    ).join('') || '<div style="color:var(--text3);padding:12px">Aucun journal</div>';
    el.scrollTop = el.scrollHeight;
  } catch {}
}

// ─── Init ────────────────────────────────────────────────────────
loadDashboard();
setInterval(() => { if (currentPage === 'dashboard') loadDashboard(); }, 30000);
setInterval(() => { if (currentPage === 'logs') loadLogs(); }, 10000);
setInterval(() => { if (currentPage === 'automation') { loadSchedulerStatus(); loadQueue(); } }, 15000);
</script>
</body>
</html>
